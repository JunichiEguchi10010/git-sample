WordPress esc_urlでURLをエスケープ処理 20250417

esc_url() は、URLをエスケープ（無害化）して、XSS（クロスサイトスクリプティング）などのセキュリティリスクを減らすために使われます。

基本的な使い方
php
<a href="<?php echo esc_url( $url ); ?>">リンク</a>
このように使うことで、ユーザーが入力した $url に不正なコードが含まれていたとしても、それを取り除いて安全な形に整えてくれます。

✅ 何をしてくれるの？
危険な文字列やプロトコル（例：javascript:）を除外

HTMLエンティティ化（& → &amp; など）

http, https, mailto, tel など、許可されたプロトコルだけを通す

❗使うべき場面
<a href=""> の中

<link href="">

<script src="">

<img src="">

など、URLをHTML属性に出力する場所では、基本的に esc_url() を使うのがベストです。

❌ 使わないほうがいい場面
HTML以外の文脈（例：JSONやJavaScript内部など）では他のエスケープ関数（例：wp_json_encode()など）を使うべきです。

✨補足：出力ではなく保存のときは？
保存のときには esc_url() ではなく sanitize_url() という関数を使うのが一般的です。

まとめ

関数名	目的	タイミング
esc_url()	安全に出力するため	表示のとき
sanitize_url()	安全に保存するため	データ保存時




😈 XSSとは？
悪意のあるユーザーが、JavaScriptなどのスクリプトを他のユーザーのブラウザで実行させる攻撃です。

💥 どんなことが起こるの？
XSSが成功すると、以下のようなことが可能になります：

ユーザーのクッキーを盗む（ログイン情報の乗っ取り）

フォームに偽の入力欄を表示して情報を盗む（フィッシング）

ユーザーの代わりに勝手に操作する（SNSで勝手に投稿など）

👇 たとえばこんな攻撃
コメント欄にこんなコードが入力されたとします：

html
<script>alert('あなたのクッキーは盗まれました');</script>
それがエスケープされずに表示されると、ページを見た人のブラウザでそのまま実行されてしまい、alert()のようにポップアップを出したり、もっと悪質なコードも動いてしまいます。

🔐 XSSを防ぐには？
入力を信用しない

ユーザーが入力した内容は「何でも入れられる」と思って対処する。

出力時にエスケープする

esc_html()：HTMLに出力する場合

esc_attr()：HTML属性値に出力する場合

esc_url()：URLに出力する場合 ←これ！

WAF（Web Application Firewall）を使う

サーバー側で防御する仕組みを入れておくのも大事です。


🎯 XSSの種類（ちょっと上級）

種類	特徴
Stored XSS（保存型）	サイトに保存されたデータから実行される（例：掲示板の書き込み）
Reflected XSS（反射型）	URLに仕込んで、アクセスした瞬間に実行される
DOM-based XSS	JavaScriptの処理によって動的に作られるページ内で起きる

✅ まとめ：XSSはなぜ危ないの？
見た目は普通のページ

バックエンドの認証も突破されてない

でも「表示側」で悪意のあるコードが実行される！

だから、表示のときには絶対にエスケープが必要なんです。