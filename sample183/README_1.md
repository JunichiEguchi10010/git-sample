リニューアル公開・運用の仕組み 20251115

🔄 リニューアルはどうやるのが正解？
テスト環境で準備 → 新しいサイトを別環境で完成させてから公開
切り替えタイミングを計画 → アクセスが少ない時間帯に反映
バックアップ必須 → 旧サイトやデータベースを保存しておく

🌐 DNS・Aレコード・MXレコード
DNS：ドメイン名をIPアドレスに変換する仕組み
Aレコード：ドメイン → サーバーのIPアドレスを紐づける設定
MXレコード：メールをどのサーバーで受け取るかを指定する設定
👉 サイトとメールの両方に直結するので、変更時は慎重に

Dnsの基本と役割
DNSは「人が覚えやすい名前（example.com）」と「機械が通信に使う住所（IPアドレス）」を結びつける住所録です。
Webサイトを表示したり、メールを届けたりする時に、この住所録を参照して正しいサーバーへ案内します。

✅ Aレコードの意味と使い方
役割: ドメイン（例: example.com）やサブドメイン（例: api.example.com）を、特定のIPv4アドレス（例: 203.0.113.10）に結びつけます。

いつ使う: サイトを置いているサーバーが「固定IP」を持っていて、そこへ直接向けたい時。

設定の例:
rootドメイン → 203.0.113.10
サブドメイン（www）→ 203.0.113.10

よくある誤り:
IPの打ち間違い → サイトが表示されなくなる。
wwwとrootの片方だけ設定 → 片方のURLだけ表示できない。
TTL（キャッシュ時間）の設定ミス → 切り替え反映が遅すぎる/速すぎる。

✅ Mxレコードの意味と使い方
役割: ドメイン宛てのメールを「どのメールサーバーで受け取るか」を指定します（例: mail.example.com）。
優先度（Preference）: 数字が小さいほど優先度が高く、主系と予備系を並べて冗長化できます。

関連レコード:
A/AAAA: MXが指すホスト名（mail.example.com）は最終的にIPに解決できる必要あり。
TXT（SPF）: 送信元の正当性を示す。なりすまし対策。
TXT（DKIM）: 署名で改ざん防止。
TXT（DMARC）: 受信側の取り扱い方針を宣言。

よくある誤り:
MXをIPで直指定（MXはホスト名で指定するのが正）。
MXだけ変えてA未設定（mail.example.comが解決できず受信不能）。
SPF/DKIM/DMARCの未設定（送信が迷惑メール扱いになりやすい）。

✅ Cnameとの違いと使いどころ
Aレコード: ドメイン → IPを直接結びつける。
CNAMEレコード: ドメイン → 別のドメイン名（別名）に転送し、その先でIPに解決する。

使いどころ:
wwwをrootへ揃える: www.example.com を example.com へCNAMEで向ける。
外部サービスに委ねる: blog.example.com を external.host.example.net へCNAME。

注意点:
rootドメインにCNAME不可（多くのDNSで非推奨/不可）。rootにはA/AAAAを置く。
MXの先にCNAME不可（MXが参照するホストはA/AAAAに最終解決できる必要）。
変更時に起きること（伝播と反映時間）
TTL（Time To Live）: DNSのキャッシュ寿命。短くすると切り替えが早く、長いと安定するが反映に時間がかかる。

事前準備のコツ:
切り替え前日にTTLを短く（例: 300秒）→ 本番切り替えをスムーズに。
切り替え後にTTLを戻す（例: 3600〜14400秒）→ 不要な負荷を避け安定運用。

安心して運用するためのチェックポイント
サイト側（A/AAAA/CNAME）:
IPの正確性: 本番サーバーのグローバルIPか。
wwwとrootの整合: どちらにも正しく到達するか。
CDN利用時: CDN指定のレコード形式に従う（多くはCNAME）。

メール側（MX/TXT）:
MXの主系・予備系: 優先度で冗長化。
SPF/DKIM/DMARC: 送信の信頼性と到達率を担保。
外部メール（Google/Microsoft等）: 指定ガイド通りのMX/TXTを反映。

全体設計:
TTL運用計画: 事前に短縮→切替→安定化。
監視とテスト: nslookup/digでレコード確認、実際にアクセス/送受信テスト。
段階的移行: まずメール、次にWebなど、影響の大きい順に分けて切替。

直観的なたとえ
DNS全体: 会社の内線表。名前を言うと交換手が正しい部署の電話番号（IP）に繋げてくれる。
Aレコード: 部署の固定電話番号を名簿に記載する。
MXレコード: 郵便の配達先を総務に指定する（総務が各部署へ振り分け）。
CNAME: 「新社屋に移転したので、窓口は新住所へ」という案内板。最終的な住所はその案内の先に書いてある。

✅ 実務での変更方法（全体像）
制作より「公開・運用」を守るために、変更は管理画面での設定と事前テストの合わせ技で進めます。
基本は「どこでDNSを管理しているか」を特定し、その管理画面でA/MX/TXTなどを編集します。
切り替え当日は、事前にTTL短縮→値変更→動作確認→TTL戻しの流れが安全です。

📝 わかりやすい流れにするとこうなります
管理画面にログイン → ドメインを契約している会社（お名前.com、Xserver、Cloudflareなど）の「DNS設定画面」に入る
現状の設定を控える → Aレコード、MXレコード、TXTレコードをスクショやメモで保存（万一のロールバック用）
TTLを短くする → 「キャッシュの寿命」を短くするだけ。数字を 3600（1時間）→ 300（5分）に変更する程度

新しい値に書き換える → 新サーバーのIPをAレコードに入力、メールサーバーのホスト名をMXに入力など
動作確認 → nslookup や dig コマンド、または「DNSチェックツール」で解決先が正しいか確認 → 実際にブラウザでサイト表示、メール送受信テスト
問題なければTTLを戻す → 300秒から元の3600秒や14400秒に戻して安定運用


管理場所の特定とアクセス
管理先の確認:
ドメイン取得先（例: お名前.com、ムームードメイン）か、ホスティング（例: Xserver、さくら）のDNSか、CDN（例: Cloudflare）か。

ログイン権限の確保:
DNS管理画面に入れるアカウント、二要素認証、有効な連絡先を確認。

現状の洗い出し:
現在のレコード一覧のエクスポート（スクショでも可）。誤操作時の復元に使う。

具体的な編集手順（Aレコード／MXレコード／TXT）
Aレコード（Webの向き先）
変更前準備:
新サーバーのグローバルIPを確定。テスト用サブドメイン（例: test.example.com）で先に動作確認。

編集手順:
TTLを短縮（例: 300秒）。
対象レコードを編集（root: example.com、www: www.example.com）。
wwwの扱い: wwwを使うならAを両方、もしくはwwwをCNAMEでrootへ。

確認:
dig/nslookupで解決先IPを確認。
ブラウザ実機確認（http/https両方）。
TLS証明書（Let’s Encrypt等）が新環境で有効か。

MXレコード（メールの受信先）
変更前準備:
受信サーバーのMXホスト名（例: aspmx.l.google.com）と優先度を確認。
SPF/DKIM/DMARCのTXT値も取得。

編集手順:
TTLを短縮。

MXをホスト名で登録（IPを直接書かない）。
MXが指すホスト名にA/AAAAが存在することを確認。
SPF（TXT）を更新（送信元サービスを列挙）。DKIM（TXT）とDMARC（TXT）を追加/更新。

確認:
切替後に外部から受信テスト、自分からの送信テスト。
迷惑メール判定やメール到達率をチェック。

TXT（SPF/DKIM/DMARC）
SPF:
送信するサービスをincludeで列挙（例: include:_spf.google.com）。
重複や複数SPFはNG、1レコードに統合。

DKIM:
メールサービス側が出すセレクタ名.ドメインのTXTをそのまま登録。

DMARC:
ポリシー（none/quarantine/reject）とレポート送信先を設定。最初はnoneで様子見が安全。

安全な切り替え運用（当日〜直後）
当日の段取り:
アクセスが少ない時間帯で実施。関係者に周知。
バックアップ（現行レコードの控え、Web/DB/メールの重要データ）。

切り替えの順序:
テスト用サブドメインで本番環境の動作確認 → 本番A/MXを切替。
リダイレクト設定（301）をサーバー側・.htaccess・アプリ設定で反映。
PHPバージョンはサーバーの管理パネルで事前に上げ、ステージングで互換テスト。

反映と検証:
TTL短縮済みなら数分〜数十分で広がる。
Web: ページ表示、フォーム送信、決済/ログイン。
メール: 外部宛て送受信、迷惑判定、SPF/DKIM/DMARCパス。
問題なければTTLを標準値へ戻す（例: 3600〜14400）。

現場で使う確認・ロールバック・監視
確認コマンド・方法:
dig/nslookup: A/MX/TXTが意図通りか確認。
ブラウザとcurl: HTTP/HTTPS、リダイレクト挙動。
メールヘッダ確認: SPF/DKIM/DMARCの結果（pass/fail）。

ロールバック計画:
変更前のレコードに即戻せるよう控えを用意。
問題箇所を特定したら、先にTTL短縮→戻す→原因切り分け。

簡易監視:
死活監視（HTTP 200/応答時間）。
メール到達率のログ（サービスの送信レポート）。
証明書期限と自動更新の成否。

よくある落とし穴と予防
落とし穴:
MXをIPで登録（無効）。
rootにCNAME（避ける／不可のことが多い）。
SPFを複数レコード（評価失敗）。
TTL未短縮で切替（反映がばらつく）。
wwwだけ切替してroot未対応（不整合）。

予防:
チェックリスト化（対象・値・TTL・確認方法・ロールバック手順）。
ステージングで総合テスト。
段階的切替（先にメール、次にWebなど）。



↪️ リダイレクトはどうするのか
301リダイレクト：恒久的な移動。SEO的にも推奨

302リダイレクト：一時的な移動
👉 古いURLから新しいURLへ正しく誘導しないと、検索順位やユーザー体験に悪影響

主要比較（意味・SEO・使い所）
項目	            301リダイレクト	                                 302リダイレクト
意味	            恒久的な移動	                                 一時的な移動
検索エンジンの認識	 新URLが正規	                                  旧URLが正規（基本）
評価の引き継ぎ	     あり（旧URLの評価を新URLへ）	                   基本的になし
代表的な用途	     ドメイン変更、URL設計の見直し、常時SSLでのwww統一	メンテ中の一時案内、キャンペーン特設、ABテスト
リスク	            誤用すると旧URLが消え、戻すのが大変	               誤用すると評価が分散・更新されない

正しい使い分けの判断軸
将来も新URLを使い続けるなら301（サイト移転、構造変更、末端ページの統合）。
旧URLのランキングや被リンク評価を新URLに移す意図を検索エンジンへ伝えます。

期間限定の移動なら302（メンテナンスや一時公開、期間限定LP）。
検索エンジンには「正規は旧URLのまま」と伝えます。

厳密版も存在：307（厳密な一時移動）、308（厳密な恒久移動）。
HTTPメソッドを変えない前提の厳密運用が必要なときに使います。

実装例（サーバー設定とアプリ）
Apache（.htaccess）
恒久移動（301）

コード
Redirect 301 /old-page https://example.com/new-page
ドメイン全体の統合（wwwなしへ）

コード
RewriteEngine On
RewriteCond %{HTTP_HOST} ^www\.example\.com$ [NC]
RewriteRule ^(.*)$ https://example.com/$1 [R=301,L]
これらは「新URLが正規」と伝えるため、移転や統一に適します。

Nginx
単ページの恒久移動（301）

コード
location = /old-page {
    return 301 https://example.com/new-page;
}
ドメイン統合（www→非www）

コード
server {
    server_name www.example.com;
    return 301 https://example.com$request_uri;
}
サーバー側でHTTPステータスを返す形が推奨。JavaScriptやmeta refreshは原則避けます。

アプリ（PHPの例：一時移動・302）
コード
header("Location: /temporary", true, 302);
exit;
メンテナンスや一時的なLP差し替えなどで使います。

SEOとUXの要点
サイト移転時は301が基本：旧URLの評価（被リンク、順位）を新URLに引き継ぐシグナル。
サイト構造の変更やURL統一のときに必須です。

302は「案内だけ」：ユーザーは新URLへ誘導されるが、検索エンジンは旧URLを正規と見なしやすい。
恒久移転で使うと評価が移らず損失が起きることがある。

確認方法：ブラウザの開発者ツール、curlでステータスコードを確認。
Search Consoleのインデックス状況監視も有効。

よくある落とし穴と回避策
302で移転を実施してしまう：評価が移らず順位低下。恒久移動は必ず301（または308）で設定。
リダイレクトチェーン：旧→中間→新の多段はクロール効率とUX低下。1ホップで新URLへ直接誘導するマップに修正。
無限ループ：www統一やHTTPS化で条件ミス。正規ホストとプロトコルを一意に決め、条件を厳密に。
meta refresh/JSでの転送：検索エンジンへの意図伝達が不十分。サーバー側のHTTPステータスで返す。

移転時の実務チェックリスト（要点）
マッピング：旧→新URLの1対1対応表を作る（カテゴリ単位も含む）。
テスト：ステージングで301挙動とコンテンツ到達確認。重要ページは個別テスト。
公開：本番で301設定→即時クロール誘導（サイトマップ更新、Search Console監視）。
後処理：内部リンクとcanonicalを新URLへ更新。チェーンや孤立URLを除去。


🖥️ PHPのバージョン
サーバーで動くプログラム言語の「実行環境」
古いバージョン：セキュリティリスクや動作不具合
新しいバージョン：高速・安全だが、古いコードが動かない場合あり
👉 リニューアル時に必ず確認・テスト

🔍 現状のドメインパワー評価を確認する方法
1. 検索順位（SEOの直接的な指標）
Google検索での順位 → 主要キーワードで何位に出ているか
Search Console → インプレッション数、クリック数、平均掲載順位を確認 👉 上位に安定して出ているなら「評価が高い」と言える

2. 被リンク（外部からの信頼度）
Search Consoleのリンクレポート → どのサイトからリンクされているか
外部ツール（Ahrefs, Moz, Majesticなど） → 被リンク数や質をスコア化してくれる 👉 質の高いサイトからリンクが多いほど評価が高い

3. ドメインオーソリティ（総合的な信頼度）
MozのDomain Authority (DA) や AhrefsのDomain Rating (DR) 👉 数値が高いほど検索エンジンから信頼されていると考えられる

4. トラフィック（実際の利用状況）
Google Analytics → オーガニック検索からの流入数
直帰率や滞在時間 → ユーザーが満足しているかどうかの間接的な評価 👉 検索順位だけでなく、ユーザー行動も評価に影響する

5. 技術的健全性
ページ速度（Core Web Vitals）

モバイル対応
セキュリティ（HTTPS化） 👉 技術的に問題が少ないほど評価が安定する

📝 まとめ
評価が高いか低いかは「検索順位＋被リンク＋ドメイン信頼度＋トラフィック＋技術的健全性」で総合的に判断します。
特に Search Console は無料で公式データが見られるので必須。
外部ツールを併用すると「被リンクやドメインスコア」も数値で把握できます。

インプレッション数 → 検索結果に表示される回数。検索エンジンが「関連性が高い」と判断している証拠。
クリック数 → 実際にユーザーが選んで訪問している証拠。魅力的なタイトルや説明が効いている。
平均掲載順位 → 検索結果での位置。上位にあるほど「評価が高い」と言える。