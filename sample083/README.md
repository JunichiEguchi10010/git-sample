WordPress サブクエリのページネーション404エラー問題 20250529

【状況】
カスタム投稿をサブクエリで設定している場合に、メインクエリのページ数がサブクエリのページ数を上回った場合（投稿数ではない）に、
2ページ目以降のページネーションが404エラーになるという問題について

一般的なプログラミングの用語で言えば、「グローバル変数の影響による予期しない動作」とも言えます。
WordPressでは paged がグローバルに管理されており、それがメインクエリの仕様に基づいてページネーションを制御するため、
サブクエリのページネーションが独立して動作しないという問題です。

🟨【カスタム投稿（サブクエリ）のページネーションが、WorPressの仕様によりメインクエリのページ数（投稿数ではない）に依存してしまい、
そのページ数をこえたカスタム投稿（サブクエリ）のページ数があると、超えた部分のページネーションは404エラーとなってしまう状況】


✅ 方法①: メインクエリーを書き換える(推奨)
functions.php でメインクエリーの投稿タイプをカスタム投稿（ニュースなど）に変更
query->set('post_type', 'news'); でメインクエリーを設定
query->set('posts_per_page', 5); で表示件数を決定
front-page.php のサブクエリーを削除し、メインクエリーのループ処理に変更 ➡ メインクエリーのページネーションを直接管理し、404エラーを防ぐ

✅ 方法②: メインクエリとサブクエリのページネーションを独立させる
メインクエリーは paged で通常のページネーションを管理
サブクエリーは sub_paged という別のGET変数で独立管理 ➡ メインクエリーとは関係なく、サブクエリー専用のページネーションを動作させる

✅ 方法③: 独自のページネーションリンクを追加
WordPressの paginate_links() はメインクエリーを基準に動作
サブクエリー専用のリンクを作成し、独立したページネーションを適用 ➡ サブクエリーのページ送りをメインクエリーと完全に分離する


ページネーションで404エラーが起こる原因
WordPressのページネーション（ページ送り）を実装すると、2ページ目や3ページ目にアクセスした際に「404エラー」になることがあります。
主な原因として、以下の3つが考えられます。

1. パーマリンク設定の問題
WordPressのパーマリンク設定が適切でないと、ページネーションのURLが正しく認識されず、404エラーが発生します。
例：「https://example.com/news/page/2/」というURLが動作しない。

2. クエリーの誤設定
WP_Query や query_posts() でカスタムクエリーを使って投稿を取得する際、ページネーションを考慮した設定がされていないと404エラーの原因になります。
posts_per_page の設定ミスや、ページ番号（paged）が正しく渡されていない場合も該当します。

3. メインクエリーとサブクエリーの衝突
カスタム投稿や特定のカテゴリーを表示する場合、メインクエリーではなくサブクエリーを使うことがあります。
ただし、サブクエリーではページネーションが適切に動作しない場合があり、404エラーにつながることがあります。

解決方法
1. パーマリンクの再設定
「設定」→「パーマリンク設定」 に移動し、何も変更せずに「変更を保存」をクリックしてみてください。 
これにより、WordPressのパーマリンクが再構築され、ページネーションが正しく認識されることがあります。

2. WP_Query の設定を見直す
ページネーションのクエリーを正しく処理するために、pagedパラメータを追加しましょう。 
以下のコードを functions.php または template の適切な場所に追加します。

php
$paged = (get_query_var('paged')) ? get_query_var('paged') : 1;
$args = array(
    'post_type' => 'post',  // 例: 通常の投稿
    'posts_per_page' => 5,   // 1ページに表示する件数
    'paged' => $paged        // 現在のページ番号を取得
);
$query = new WP_Query($args);
こうすることで、ページネーションのURLに応じて正しい投稿が取得されます。

3. メインクエリーをカスタム投稿に変更（）
カスタム投稿をメインクエリーとして動作させる場合、以下のコードを functions.php に追加して、ページネーションが正しく動作するように変更します。

php
function modify_main_query($query) {
    if (!is_admin() && $query->is_main_query() && is_home()) {
        $query->set('post_type', 'news'); // カスタム投稿タイプの「news」をメインに
        $query->set('posts_per_page', 5);
    }
}
add_action('pre_get_posts', 'modify_main_query');
これにより、WordPressがデフォルトの投稿ではなく、カスタム投稿の「news」をメインクエリーとして扱うようになります。

まとめ
404エラーの主な原因は パーマリンク設定の問題・クエリー設定ミス・メインクエリーとサブクエリーの衝突 。

パーマリンクの再保存 は簡単に試せる解決策。

クエリーに paged パラメータを追加 し、ページネーションが正しく動作するようにする。

functions.phpでメインクエリーを変更 すると、カスタム投稿のページネーションも正常に機能する。


【WordPress】ページネーション404 本当の対応方法【ネットの９割が間違ってる】
 https://www.youtube.com/watch?v=hOm8rj8O9yw