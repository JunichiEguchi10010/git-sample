WordPress メインクエリとサブクエリ 20250426


1. そもそも「クエリ」とは？
ユーザーがURLを指定すると、サーバーにリクエストが飛び、
データベースから投稿データを検索して取り出します。
取り出したデータはWP_Queryオブジェクトにまとめられ、
それをPHPでHTMLに変換して表示している。
つまり、URLに応じたデータを探してきて、画面に出している仕組みです。

2. 「メインクエリ」とは？
WordPressがURLに応じて自動的に作成するクエリ。
例：トップページなら「最新記事一覧」を持ってくる。
これが「メインループ」と呼ばれるもの。
つまり、何も特別なことをしなくても動く基本の流れです。

3. 「サブクエリ」とは？
たとえば、トップページで「お知らせ」と「制作実績」みたいに複数の異なる一覧を表示したいとき、
メインクエリとは別に自分で新しいクエリ（＝サブクエリ）を作る必要がある。
サブクエリはWP_Queryクラスを使って自分で条件（投稿タイプ、件数など）を設定して作る。

イメージ：
メインクエリ → トップページ用の基本情報
サブクエリ → それ以外に追加で出したい情報

4. 実際のコードの違い
メインクエリ（お知らせ）	                                          サブクエリ（制作実績）
if (have_posts()) : while (have_posts()) : the_post();	          $the_query = new WP_Query(条件); if ($the_query->have_posts()) : while ($the_query->have_posts()) : $the_query->the_post();
特別な準備なしでループ開始	                                        新しいクエリオブジェクトを作成してからループ開始
※(自動的にWP_Query->have_posts()となる)
※サブクエリを使った後は、必ず wp_reset_postdata(); を忘れずに！

5. 実践でよく使う場面
トップページに複数の投稿タイプを並べたいとき
固定ページにブログ一覧を出したいとき
サイドバーに最新記事やおすすめ記事を出したいとき

6. 応用編（軽く紹介）
サブクエリの条件指定は自由自在（カテゴリ・タグ・カスタム投稿タイプなど）。
条件を組み合わせてさらに複雑な表示も可能。
functions.phpでメインクエリを直接カスタマイズする方法もある（pre_get_postsフック）。


【まとめ】
✅ メインクエリ＝URLに応じた標準のデータ取得
✅ サブクエリ＝別で自分で作る追加データ取得
✅ サブクエリを使うと、ページをもっと自由にカスタマイズできる


メインクエリ、サブクエリ解説！WordPressで自由自在に投稿情報を出力する！（連結講座#5）
https://www.youtube.com/watch?v=03ZSooJCB1Q